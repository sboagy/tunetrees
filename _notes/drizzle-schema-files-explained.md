# Drizzle Schema Files - Complete Explanation

**Date:** October 8, 2025  
**Project:** TuneTrees PWA (feat/pwa1)

---

## Overview: Schema File Architecture

Your project uses a **dual-database architecture** with different schema files for each purpose. Here's the complete structure:

```
drizzle/
‚îú‚îÄ‚îÄ schema-postgres.ts          ‚Üê üü¢ ACTIVE: PostgreSQL/Supabase schema (hand-maintained)
‚îú‚îÄ‚îÄ schema-sqlite.ts            ‚Üê üü¢ ACTIVE: SQLite WASM schema (auto-generated)
‚îú‚îÄ‚îÄ schema.ts                   ‚Üê üî¥ UNUSED: Empty file (legacy?)
‚îú‚îÄ‚îÄ sync-columns.ts             ‚Üê üü¢ ACTIVE: Shared sync column definitions
‚îú‚îÄ‚îÄ migrations/
‚îÇ   ‚îú‚îÄ‚îÄ postgres/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ schema.ts           ‚Üê üü° GENERATED: Pulled from Supabase (read-only)
‚îÇ   ‚îî‚îÄ‚îÄ sqlite/
‚îÇ       ‚îî‚îÄ‚îÄ *.sql               ‚Üê üü° GENERATED: Migration files
‚îî‚îÄ‚îÄ drizzle.config.ts           ‚Üê üü¢ CONFIG: PostgreSQL Drizzle Kit config
‚îî‚îÄ‚îÄ drizzle.config.sqlite.ts    ‚Üê üü¢ CONFIG: SQLite Drizzle Kit config

src/lib/db/
‚îî‚îÄ‚îÄ schema.ts                   ‚Üê üü¢ ACTIVE: Re-export for backward compatibility
```

---

## File-by-File Breakdown

### 1. `drizzle/schema-postgres.ts` üü¢

**Purpose:** Source of truth for PostgreSQL/Supabase schema

**Characteristics:**

- ‚úÖ Hand-maintained by developers
- ‚úÖ PostgreSQL-specific types (`serial`, `uuid`, `timestamp`, `boolean`)
- ‚úÖ Includes RLS policies (`pgPolicy`)
- ‚úÖ Includes check constraints
- ‚úÖ Uses `pgSyncColumns` helper for sync columns
- ‚úÖ Used by `drizzle.config.ts`

**Sample:**

```typescript
import {
  pgTable,
  serial,
  text,
  timestamp,
  uuid,
  boolean,
} from "drizzle-orm/pg-core";
import { pgSyncColumns } from "./sync-columns";

export const userProfile = pgTable("user_profile", {
  id: serial().primaryKey(),
  supabaseUserId: uuid("supabase_user_id").unique().notNull(),
  email: text().notNull(),
  name: text(),
  ...pgSyncColumns, // sync_version, last_modified_at, device_id
});
```

**When to Edit:** When you need to make schema changes (add columns, tables, etc.)

---

### 2. `drizzle/schema-sqlite.ts` üü¢

**Purpose:** SQLite WASM schema for offline-first local storage

**Characteristics:**

- ‚úÖ **Auto-generated** by `scripts/convert-postgres-to-sqlite-schema.ts`
- ‚úÖ SQLite-specific types (`integer`, `text`, `real`)
- ‚ö†Ô∏è NO RLS policies (removed during conversion)
- ‚ö†Ô∏è NO check constraints (removed during conversion)
- ‚úÖ Includes sync columns (converted types)
- ‚úÖ Used by `drizzle.config.sqlite.ts`

**Sample:**

```typescript
import { sqliteTable, integer, text } from "drizzle-orm/sqlite-core";

export const userProfile = sqliteTable("user_profile", {
  id: integer("id").primaryKey({ autoIncrement: true }),
  supabaseUserId: text("supabase_user_id").unique().notNull(),
  email: text().notNull(),
  name: text(),
  syncVersion: integer("sync_version").default(1).notNull(),
  lastModifiedAt: text("last_modified_at")
    .$defaultFn(() => new Date().toISOString())
    .notNull(),
  deviceId: text("device_id"),
});
```

**When to Edit:** NEVER manually! Always regenerate with the conversion script.

**Header:**

```typescript
/**
 * Auto-generated by: scripts/convert-postgres-to-sqlite-schema.ts
 * Source: drizzle/migrations/postgres/schema.ts
 * Generated: 2025-10-08T05:20:18.388Z
 */
```

---

### 3. `drizzle/migrations/postgres/schema.ts` üü°

**Purpose:** Snapshot of current Supabase schema (pulled from cloud)

**Characteristics:**

- ‚úÖ **Auto-generated** by `npx drizzle-kit pull`
- ‚úÖ Represents actual state of Supabase database
- ‚úÖ PostgreSQL-specific types
- ‚úÖ Includes all RLS policies and constraints
- ‚ö†Ô∏è Read-only (used as source for conversion script)

**How It's Created:**

```bash
npx drizzle-kit pull
# Introspects Supabase database
# Generates this file from actual PostgreSQL schema
```

**Sample:**

```typescript
import {
  pgTable,
  foreignKey,
  pgPolicy,
  check,
  serial,
  integer,
  text,
  timestamp,
  index,
  unique,
  uuid,
  boolean,
  real,
  primaryKey,
  pgView,
} from "drizzle-orm/pg-core";

export const tabGroupMainState = pgTable(
  "tab_group_main_state",
  {
    id: serial().primaryKey().notNull(),
    userId: integer("user_id").notNull(),
    // ... more columns
  },
  (table) => [
    foreignKey({
      /* FK definition */
    }),
    pgPolicy("Users can view own tab group state", {
      /* RLS policy */
    }),
    check("check_name", sql`which_tab = ANY (ARRAY['scheduled'::text, ...])`),
  ]
);
```

**When to Use:**

- As source for conversion script
- To verify what's actually in Supabase
- To compare hand-maintained vs. actual schema

---

### 4. `drizzle/schema.ts` üî¥

**Purpose:** Unknown/Legacy (currently empty)

**Status:** ‚ö†Ô∏è **UNUSED - Can be deleted**

**Contents:** Empty file

**Why It Exists:** Likely leftover from initial Drizzle setup or migration

**Recommendation:** Safe to delete unless you find imports referencing it

---

### 5. `src/lib/db/schema.ts` üü¢

**Purpose:** Re-export SQLite schema for backward compatibility

**Characteristics:**

- ‚úÖ **Re-export only** (no schema definitions)
- ‚úÖ Provides stable import path for app code
- ‚úÖ Points to `drizzle/schema-sqlite.ts`

**Full Contents:**

```typescript
/**
 * Database Schema for TuneTrees
 *
 * This file re-exports the SQLite schema from drizzle/schema-sqlite.ts
 * to maintain backward compatibility with existing imports.
 *
 * @module lib/db/schema
 */

// Re-export everything from the generated SQLite schema
export * from "../../../drizzle/schema-sqlite";
```

**Why It Exists:**

- Allows app code to import from `@/lib/db/schema` instead of deep path
- Decouples app from schema file location
- Makes future refactoring easier

**Usage in App:**

```typescript
// ‚úÖ Good: Clean import path
import { userProfile, playlist, tune } from "@/lib/db/schema";

// ‚ùå Bad: Direct import (brittle)
import { userProfile } from "../../../drizzle/schema-sqlite";
```

---

### 6. `drizzle/sync-columns.ts` üü¢

**Purpose:** Shared sync column definitions

**Characteristics:**

- ‚úÖ Reusable column definitions
- ‚úÖ Separate for PostgreSQL (`pgSyncColumns`) and SQLite (`sqliteSyncColumns`)
- ‚úÖ Ensures consistency across all tables

**Contents:**

```typescript
import { integer, text, timestamp } from "drizzle-orm/pg-core";

// PostgreSQL sync columns
export const pgSyncColumns = {
  syncVersion: integer("sync_version").default(1).notNull(),
  lastModifiedAt: timestamp("last_modified_at").defaultNow().notNull(),
  deviceId: text("device_id"),
};

// SQLite sync columns
export const sqliteSyncColumns = {
  syncVersion: integer("sync_version").default(1).notNull(),
  lastModifiedAt: text("last_modified_at")
    .$defaultFn(() => new Date().toISOString())
    .notNull(),
  deviceId: text("device_id"),
};
```

**Usage:**

```typescript
// In schema-postgres.ts
export const myTable = pgTable("my_table", {
  id: serial().primaryKey(),
  // ... other columns
  ...pgSyncColumns, // Spread sync columns
});

// In schema-sqlite.ts (auto-generated)
export const myTable = sqliteTable("my_table", {
  id: integer("id").primaryKey({ autoIncrement: true }),
  // ... other columns
  ...sqliteSyncColumns, // Spread sync columns
});
```

---

## Configuration Files

### `drizzle.config.ts` (PostgreSQL)

```typescript
export default defineConfig({
  schema: "./drizzle/schema-postgres.ts", // ‚Üê Uses hand-maintained schema
  out: "./drizzle/migrations/postgres",
  dialect: "postgresql",
  dbCredentials: {
    url: process.env.DATABASE_URL || "",
  },
});
```

**Commands:**

- `npx drizzle-kit pull` ‚Üí Generate `migrations/postgres/schema.ts` from Supabase
- `npx drizzle-kit push` ‚Üí Push `schema-postgres.ts` to Supabase
- `npx drizzle-kit generate` ‚Üí Generate SQL migrations
- `npx drizzle-kit studio` ‚Üí Open Drizzle Studio for PostgreSQL

---

### `drizzle.config.sqlite.ts` (SQLite)

```typescript
export default defineConfig({
  schema: "./drizzle/schema-sqlite.ts", // ‚Üê Uses auto-generated schema
  out: "./drizzle/migrations/sqlite",
  dialect: "sqlite",
  dbCredentials: {
    url: "./tunetrees_local.sqlite3",
  },
});
```

**Commands:**

- `npx drizzle-kit push --config=drizzle.config.sqlite.ts` ‚Üí Apply schema to local DB
- `npx drizzle-kit studio --config=drizzle.config.sqlite.ts` ‚Üí Open Studio for SQLite
- `npx drizzle-kit generate --config=drizzle.config.sqlite.ts` ‚Üí Generate migrations

---

## Workflow: How These Files Work Together

### Scenario 1: Making Supabase Schema Changes

```bash
# 1. Edit the source schema
vim drizzle/schema-postgres.ts
# Add: ALTER TABLE tune ADD COLUMN complexity integer;

# 2. Push to Supabase
npx drizzle-kit push

# 3. Pull updated schema (verification)
npx drizzle-kit pull
# Creates: drizzle/migrations/postgres/schema.ts

# 4. Convert to SQLite
npx tsx scripts/convert-postgres-to-sqlite-schema.ts
# Updates: drizzle/schema-sqlite.ts

# 5. Apply to local SQLite
npx drizzle-kit push --config=drizzle.config.sqlite.ts

# 6. Verify
sqlite3 tunetrees_local.sqlite3 "PRAGMA table_info(tune);"
```

### Scenario 2: Syncing Supabase Changes to Local

```bash
# Someone else made changes in Supabase

# 1. Pull latest schema
npx drizzle-kit pull
# Updates: drizzle/migrations/postgres/schema.ts

# 2. Convert to SQLite
npx tsx scripts/convert-postgres-to-sqlite-schema.ts
# Updates: drizzle/schema-sqlite.ts

# 3. Apply to local SQLite
npx drizzle-kit push --config=drizzle.config.sqlite.ts
```

### Scenario 3: App Code Using Schemas

```typescript
// src/lib/db/client.ts
import { drizzle } from "drizzle-orm/sqlite-proxy";
import * as schema from "./schema"; // ‚Üê Points to schema-sqlite.ts

export const db = drizzle(/* ... */, { schema });

// src/components/TunesList.tsx
import { tune, playlist } from "@/lib/db/schema"; // ‚Üê Clean import
import { db } from "@/lib/db/client";

export function TunesList() {
  const [tunes] = createResource(async () => {
    return await db.select().from(tune).all(); // ‚Üê Type-safe
  });
}
```

---

## Type Conversions (PostgreSQL ‚Üí SQLite)

| PostgreSQL Type   | SQLite Type                                         | Example                 |
| ----------------- | --------------------------------------------------- | ----------------------- |
| `serial()`        | `integer().primaryKey({ autoIncrement: true })`     | Primary keys            |
| `uuid()`          | `text()`                                            | UUIDs stored as strings |
| `boolean()`       | `integer()`                                         | `0` = false, `1` = true |
| `timestamp()`     | `text().$defaultFn(() => new Date().toISOString())` | ISO 8601 strings        |
| `real()`          | `real()`                                            | Same (floating-point)   |
| `text()`          | `text()`                                            | Same                    |
| `integer()`       | `integer()`                                         | Same                    |
| `.defaultNow()`   | `.$defaultFn(() => new Date().toISOString())`       | Current timestamp       |
| `.default(true)`  | `.default(1)`                                       | Boolean defaults        |
| `.default(false)` | `.default(0)`                                       | Boolean defaults        |

---

## Key Principles

### ‚úÖ DO

1. **Edit `schema-postgres.ts` manually** when making schema changes
2. **Use conversion script** to update `schema-sqlite.ts`
3. **Import from `@/lib/db/schema`** in app code
4. **Keep sync columns** on all user-owned tables
5. **Run `drizzle-kit pull`** to verify Supabase state

### ‚ùå DON'T

1. **Don't edit `schema-sqlite.ts` manually** (use conversion script)
2. **Don't edit `migrations/postgres/schema.ts`** (auto-generated)
3. **Don't import directly from `drizzle/schema-*.ts`** (use `@/lib/db/schema`)
4. **Don't forget to run conversion after Supabase changes**
5. **Don't use `schema.ts` (empty file)** (can be deleted)

---

## Quick Reference

### Active Schema Files (Use These)

| File                         | Purpose           | How Updated       | Used By                    |
| ---------------------------- | ----------------- | ----------------- | -------------------------- |
| `drizzle/schema-postgres.ts` | PostgreSQL schema | Hand-edit         | `drizzle.config.ts`        |
| `drizzle/schema-sqlite.ts`   | SQLite schema     | Conversion script | `drizzle.config.sqlite.ts` |
| `src/lib/db/schema.ts`       | App imports       | Never (re-export) | App components             |
| `drizzle/sync-columns.ts`    | Sync columns      | Hand-edit         | Both schemas               |

### Generated Files (Read-Only)

| File                                    | Purpose           | Generated By           |
| --------------------------------------- | ----------------- | ---------------------- |
| `drizzle/migrations/postgres/schema.ts` | Supabase snapshot | `drizzle-kit pull`     |
| `drizzle/migrations/sqlite/*.sql`       | Migration files   | `drizzle-kit generate` |

### Unused Files (Can Delete)

| File                | Status | Action         |
| ------------------- | ------ | -------------- |
| `drizzle/schema.ts` | Empty  | Safe to delete |

---

## Summary

Your schema architecture follows a **database-first, dual-database pattern**:

1. **PostgreSQL (Supabase)** = Source of truth

   - Hand-maintained in `schema-postgres.ts`
   - Pulled/verified with `drizzle-kit pull` ‚Üí `migrations/postgres/schema.ts`

2. **SQLite (WASM)** = Local mirror

   - Auto-generated from PostgreSQL via conversion script
   - Stored in `schema-sqlite.ts`
   - Applied with `drizzle-kit push --config=sqlite`

3. **App Code** = Imports from stable path
   - Uses `src/lib/db/schema.ts` (re-export)
   - Never imports directly from drizzle/

This architecture enables:

- ‚úÖ Offline-first development (SQLite)
- ‚úÖ Cloud sync (PostgreSQL/Supabase)
- ‚úÖ Type safety (Drizzle ORM)
- ‚úÖ Rapid schema iteration (conversion automation)
- ‚úÖ Multi-device sync (sync columns)

---

**Last Updated:** October 8, 2025
