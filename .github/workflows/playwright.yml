name: Playwright Tests

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    environment: frontend_env

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Print Node version
        run: node --version
        working-directory: frontend

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.13.1"
      - name: Create virtual environment
        run: python -m venv .venv

      - name: Activate virtual environment and install dependencies
        run: |
          source .venv/bin/activate
          pip install -r requirements.txt

      - name: Install typescript
        run: npm install -g typescript@5.8.2
        working-directory: frontend

      - name: Install node types
        run: npm install --save-dev @types/node
        working-directory: frontend

      - name: Install dependencies
        run: npm ci
        working-directory: frontend

      - name: Install Playwright Chromium Browser
        run: npx playwright install chromium --with-deps
        working-directory: frontend

      - name: Print playwright version
        run: npm list playwright --depth=0
        working-directory: frontend

      - name: Run Jest Unit Tests
        run: npm run test:unit
        working-directory: frontend

      - name: Build frontend for CI
        if: always()
        run: |
          mkdir -p frontend/test-results
          npm run build 2>&1 | tee frontend/test-results/frontend-build.log
        working-directory: frontend
        env:
          # Ensure Next.js embeds necessary env when building (for NEXT_PUBLIC_* and server rendering)
          NEXT_BASE_URL: http://localhost:3000
          TT_API_BASE_URL: http://localhost:8000
          AUTH_URL: http://localhost:3000
          AUTH_TRUST_HOST: true
          AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          TUNETREES_FRONTEND_LOG: frontend/test-results/frontend.log

      - name: Start frontend (production) in background
        if: always()
        run: |
          mkdir -p frontend/test-results
          npm run start 2>&1 | tee frontend/test-results/frontend.log &
          echo $! > .next-start.pid
        working-directory: frontend
        env:
          # Ensure runtime env for NextAuth and server-side API calls
          NEXT_BASE_URL: http://localhost:3000
          TT_API_BASE_URL: http://localhost:8000
          AUTH_URL: http://localhost:3000
          AUTH_TRUST_HOST: true
          AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          AUTH_DEBUG: true
          TUNETREES_FRONTEND_LOG: frontend/test-results/frontend.log

      - name: Wait for frontend health
        if: always()
        run: |
          for i in {1..30}; do
            if curl -sSf "http://localhost:3000/api/health" >/dev/null 2>&1; then
              echo "frontend healthy"; exit 0
            fi
            sleep 2
          done
          echo "frontend did not become healthy"; exit 1
        working-directory: frontend
        env:
          NEXT_BASE_URL: http://localhost:3000
          TT_API_BASE_URL: http://localhost:8000
          AUTH_URL: http://localhost:3000
          AUTH_TRUST_HOST: true
          AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}

      - name: Debug environment
        run: |
          echo "CI=$CI"
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
        working-directory: frontend

      # I think the way these tests are set up, we don't want to start the Next.js server manually.
      # - name: Install wait-on
      #   run: npm install -g wait-on
      #   working-directory: frontend

      # - name: Start Next.js server
      #   run: next dev --experimental-https &
      #   working-directory: frontend

      # - name: Wait for Next.js server to be ready
      #   run: wait-on https://localhost:3000
      #   working-directory: frontend

      - name: "Phase 1: Login and save cookies"
        working-directory: frontend
        env:
          PLAYWRIGHT_BASE_URL: http://localhost:3000
          NEXT_BASE_URL: http://localhost:3000
          TT_API_BASE_URL: http://localhost:8000
          # Test defaults parity
          TT_REVIEW_SITDOWN_DATE: 2024-12-31 16:47:57.671465+00:00
          THROTTLE_MAX: 0
          AUTH_TRUST_HOST: true
          AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          AUTH_GITHUB_ID: ${{ secrets.AUTH_GITHUB_ID }}
          AUTH_GITHUB_SECRET: ${{ secrets.AUTH_GITHUB_SECRET }}
          AUTH_GOOGLE_ID: ${{ secrets.AUTH_GOOGLE_ID }}
          AUTH_GOOGLE_SECRET: ${{ secrets.AUTH_GOOGLE_SECRET }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          GITHUB_CLIENT_ID: ${{ secrets.GGITHUB_CLIENT_ID }}
          GITHUB_CLIENT_SECRET: ${{ secrets.GGITHUB_CLIENT_SECRET }}
          TT_AUTH_SENDGRID_API_KEY: ${{ secrets.TT_AUTH_SENDGRID_API_KEY }}
          CI: true
          TEST1_LOGIN_USER_EMAIL: ${{ secrets.TEST1_LOGIN_USER_EMAIL }}
          TEST1_LOGIN_USER_PASSWORD: ${{ secrets.TEST1_LOGIN_USER_PASSWORD }}
        run: |
          chmod +x scripts/ci-login-save-cookies.sh
          ./scripts/ci-login-save-cookies.sh

      - name: "Phase 2: Run Frontend Playwright tests (full suite)"
        working-directory: frontend
        env:
          PLAYWRIGHT_BASE_URL: http://localhost:3000
          NEXT_BASE_URL: http://localhost:3000
          TT_API_BASE_URL: http://localhost:8000
          AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          AUTH_GITHUB_ID: ${{ secrets.AUTH_GITHUB_ID }}
          AUTH_GITHUB_SECRET: ${{ secrets.AUTH_GITHUB_SECRET }}
          AUTH_GOOGLE_ID: ${{ secrets.AUTH_GOOGLE_ID }}
          AUTH_GOOGLE_SECRET: ${{ secrets.AUTH_GOOGLE_SECRET }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          GITHUB_CLIENT_ID: ${{ secrets.GGITHUB_CLIENT_ID }}
          GITHUB_CLIENT_SECRET: ${{ secrets.GGITHUB_CLIENT_SECRET }}
          TT_AUTH_SENDGRID_API_KEY: ${{ secrets.TT_AUTH_SENDGRID_API_KEY }}
          CI: true
          STORAGE_STATE_TEST1: test-scripts/storageStateSboagyLogin.json
          TEST1_LOGIN_USER_EMAIL: ${{ secrets.TEST1_LOGIN_USER_EMAIL }}
          TEST1_LOGIN_USER_PASSWORD: ${{ secrets.TEST1_LOGIN_USER_PASSWORD }}
          TEST2_LOGIN_USER_EMAIL: ${{ secrets.TEST2_LOGIN_USER_EMAIL }}
          TEST2_LOGIN_USER_PASSWORD: ${{ secrets.TEST2_LOGIN_USER_PASSWORD }}
          TEST2_LOGIN_USER_NAME: ${{ secrets.TEST2_LOGIN_USER_NAME }}
          TEST2_LOGIN_GMAIL_PW: ${{ secrets.TEST2_LOGIN_GMAIL_PW }}
          TT_REVIEW_SITDOWN_DATE: 2024-12-31 16:47:57.671465+00:00
          THROTTLE_MAX: 0
          AUTH_TRUST_HOST: true
        run: npx playwright test --project=chromium --reporter=list
      - name: Stop frontend
        if: always()
        run: |
          if [ -f frontend/.next-start.pid ]; then
            kill "$(cat frontend/.next-start.pid)" || true
            rm frontend/.next-start.pid || true
          else
            pkill -f 'next start' || true
          fi
      - uses: actions/upload-artifact@v4
        if: ${{ always() }}
        with:
          name: playwright-report
          path: |
            frontend/test-results/
          retention-days: 30
